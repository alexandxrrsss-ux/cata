<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMaster Pro - Limpieza</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: white; }
        .admin-border { border: 2px solid #f97316; }
        .agotado { filter: grayscale(1); opacity: 0.5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ADMIN_PASSWORD = "123"; 

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [pedidos, setPedidos] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [verPedidos, setVerPedidos] = useState(false);
            const [mostrarLogin, setMostrarLogin] = useState(false);
            const [mostrarAdd, setMostrarAdd] = useState(false);
            const [passInput, setPassInput] = useState('');
            const [enviando, setEnviando] = useState(false);
            const [form, setForm] = useState({ nombre: '', cantidad: '', lugar: '', foto: null });

            useEffect(() => { 
                cargarDatos();
                cargarPedidos();
            }, []);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('created_at', { ascending: false });
                if (data) setHerramientas(data);
            };

            const cargarPedidos = async () => {
                const { data } = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
                if (data) setPedidos(data);
            };

            const guardarMaterial = async () => {
                if (enviando) return; // Evita clics dobles
                if (!form.nombre || !form.cantidad) return alert("Rellena los campos");

                setEnviando(true);
                let urlFinal = 'https://via.placeholder.com/300x200?text=Sin+Foto';

                try {
                    if (form.foto) {
                        const fileName = `${Date.now()}_${form.foto.name}`;
                        const { data: upData, error: upError } = await supabase.storage.from('herramientas').upload(fileName, form.foto);
                        if (upError) throw upError;
                        const { data: urlData } = supabase.storage.from('herramientas').getPublicUrl(fileName);
                        urlFinal = urlData.publicUrl;
                    }

                    const { error } = await supabase.from('herramientas').insert([{ 
                        nombre: form.nombre, 
                        cantidad: parseInt(form.cantidad), 
                        lugar: form.lugar, 
                        foto_url: urlFinal 
                    }]);

                    if (error) throw error;

                    alert("‚úÖ Agregado");
                    setForm({ nombre: '', cantidad: '', lugar: '', foto: null });
                    setMostrarAdd(false);
                    cargarDatos();
                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    setEnviando(false);
                }
            };

            const eliminarMaterial = async (id) => {
                if(confirm("¬øEliminar este registro repetido?")) {
                    const { error } = await supabase.from('herramientas').delete().eq('id', id);
                    if(!error) cargarDatos();
                }
            };

            // Filtrar para no mostrar duplicados visualmente (Opcional, mejor borrar los repetidos)
            const herramientasFiltradas = herramientas.filter(h => h.nombre.toLowerCase().includes(busqueda.toLowerCase()));

            return (
                <div className="max-w-6xl mx-auto p-4">
                    <nav className="flex justify-between items-center mb-6 bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
                        <h1 className="text-xl font-black text-orange-500 italic uppercase">Master Stock</h1>
                        <div className="flex gap-2">
                            {isAdmin && (
                                <button onClick={() => setVerPedidos(!verPedidos)} className="bg-blue-600 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">
                                    {verPedidos ? 'üì¶ Inventario' : `üì• Pedidos (${pedidos.length})`}
                                </button>
                            )}
                            <button onClick={() => isAdmin ? setIsAdmin(false) : setMostrarLogin(true)} className="bg-slate-700 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">
                                {isAdmin ? 'Salir' : 'Admin'}
                            </button>
                        </div>
                    </nav>

                    {mostrarLogin && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-800 p-8 rounded-3xl border border-orange-500 w-full max-w-xs">
                                <input type="password" placeholder="Clave" className="w-full p-4 bg-slate-900 rounded-xl mb-4 text-center text-xl outline-none" onChange={e => setPassInput(e.target.value)} />
                                <button onClick={() => {if(passInput===ADMIN_PASSWORD) { setIsAdmin(true); setMostrarLogin(false); }}} className="w-full bg-orange-600 py-3 rounded-xl font-bold">ENTRAR</button>
                            </div>
                        </div>
                    )}

                    {!verPedidos ? (
                        <>
                            <div className="flex gap-2 mb-8">
                                <input type="text" placeholder="Buscar herramienta..." className="flex-1 bg-slate-800 p-4 rounded-2xl outline-none border border-slate-700" onChange={e => setBusqueda(e.target.value)} />
                                {isAdmin && (
                                    <button onClick={() => setMostrarAdd(!mostrarAdd)} className="bg-green-600 px-6 rounded-2xl font-black text-xl">
                                        {mostrarAdd ? '‚úï' : '+'}
                                    </button>
                                )}
                            </div>

                            {isAdmin && mostrarAdd && (
                                <div className="bg-slate-800 p-6 rounded-[2rem] border-2 border-green-600 mb-10 shadow-2xl">
                                    <h3 className="text-xl font-black mb-4 text-green-500 uppercase">A√±adir Nuevo</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <input type="text" placeholder="Nombre" className="bg-slate-900 p-4 rounded-xl" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value})} />
                                        <input type="number" placeholder="Cantidad" className="bg-slate-900 p-4 rounded-xl" value={form.cantidad} onChange={e => setForm({...form, cantidad: e.target.value})} />
                                        <input type="text" placeholder="Ubicaci√≥n" className="bg-slate-900 p-4 rounded-xl" value={form.lugar} onChange={e => setForm({...form, lugar: e.target.value})} />
                                    </div>
                                    <input type="file" className="mb-4 block text-xs" onChange={e => setForm({...form, foto: e.target.files[0]})} />
                                    <button onClick={guardarMaterial} disabled={enviando} className="w-full bg-green-600 py-4 rounded-xl font-black uppercase disabled:opacity-50">
                                        {enviando ? 'Guardando...' : 'Confirmar Registro'}
                                    </button>
                                </div>
                            )}

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                {herramientasFiltradas.map(h => (
                                    <div key={h.id} className={`bg-slate-800 rounded-[2rem] overflow-hidden border border-slate-700 flex flex-col ${isAdmin ? 'admin-border' : ''}`}>
                                        <div className="h-48 bg-black/40 p-4"><img src={h.foto_url} className="w-full h-full object-contain" /></div>
                                        <div className="p-6 flex flex-col flex-grow">
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className="font-black uppercase text-sm">{h.nombre}</h4>
                                                <span className="bg-orange-600 px-2 py-1 rounded-lg text-[10px] font-black">CANT: {h.cantidad}</span>
                                            </div>
                                            <p className="text-[10px] text-slate-400 font-bold mb-4 italic">üìç {h.lugar}</p>
                                            
                                            {isAdmin && (
                                                <button onClick={() => eliminarMaterial(h.id)} className="mt-auto w-full py-2 text-red-500 text-[9px] font-black border border-red-500/20 rounded-lg uppercase hover:bg-red-600 hover:text-white transition-all">
                                                    Eliminar Repetido
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    ) : (
                        <div className="space-y-4">
                            <h2 className="text-xl font-black text-blue-400">PEDIDOS</h2>
                            {pedidos.map(p => (
                                <div key={p.id} className="bg-slate-800 p-6 rounded-3xl border border-slate-700 flex justify-between items-center">
                                    <div>
                                        <p className="text-orange-500 font-black uppercase text-sm">{p.herramienta_nombre} (x{p.cantidad_pedida})</p>
                                        <p className="text-[10px]">{p.usuario_nombre} - {p.tarea}</p>
                                    </div>
                                    <button onClick={async () => {
                                        // Aqu√≠ ir√≠a tu l√≥gica de entrega que resta stock
                                        await supabase.from('pedidos').delete().eq('id', p.id);
                                        cargarPedidos();
                                    }} className="bg-green-600 px-4 py-2 rounded-xl text-[10px] font-bold">‚úì</button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
