<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMaster Elite v5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .admin-mode { border: 2px solid #f97316 !important; }
        .stock-critico { border: 2px solid #ef4444 !important; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ADMIN_PASSWORD = "123"; 

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [pedidos, setPedidos] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [vista, setVista] = useState('stock'); // 'stock', 'pedidos', 'bajo'
            const [mostrarLogin, setMostrarLogin] = useState(false);
            const [mostrarForm, setMostrarForm] = useState(false);
            const [editandoId, setEditandoId] = useState(null);
            const [passInput, setPassInput] = useState('');
            const [enviando, setEnviando] = useState(false);
            const [form, setForm] = useState({ nombre: '', cantidad: '', lugar: '', foto: null, foto_url: '' });

            useEffect(() => { cargarDatos(); cargarPedidos(); }, []);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('created_at', { ascending: false });
                if (data) setHerramientas(data);
            };

            const cargarPedidos = async () => {
                const { data } = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
                if (data) setPedidos(data);
            };

            const guardarMaterial = async () => {
                if (!form.nombre || !form.cantidad) return alert("Faltan datos");
                setEnviando(true);
                let urlFinal = form.foto_url || 'https://via.placeholder.com/300x200?text=Sin+Foto';

                try {
                    if (form.foto && typeof form.foto !== 'string') {
                        const fileName = `${Date.now()}.jpg`;
                        await supabase.storage.from('herramientas').upload(fileName, form.foto);
                        const { data } = supabase.storage.from('herramientas').getPublicUrl(fileName);
                        urlFinal = data.publicUrl;
                    }

                    const payload = { nombre: form.nombre, cantidad: parseInt(form.cantidad), lugar: form.lugar, foto_url: urlFinal };

                    if (editandoId) {
                        await supabase.from('herramientas').update(payload).eq('id', editandoId);
                    } else {
                        await supabase.from('herramientas').insert([payload]);
                    }

                    setForm({ nombre: '', cantidad: '', lugar: '', foto: null, foto_url: '' });
                    setMostrarForm(false);
                    setEditandoId(null);
                    cargarDatos();
                    alert("‚úÖ Guardado correctamente");
                } catch (err) { alert(err.message); } finally { setEnviando(false); }
            };

            const prepararEdicion = (h) => {
                setForm({ nombre: h.nombre, cantidad: h.cantidad, lugar: h.lugar, foto_url: h.foto_url });
                setEditandoId(h.id);
                setMostrarForm(true);
                setVista('stock');
                window.scrollTo(0,0);
            };

            const stockCritico = useMemo(() => herramientas.filter(h => h.cantidad <= 3), [herramientas]);

            const TarjetaHerramienta = ({ h }) => (
                <div className={`bg-slate-800 rounded-[2.5rem] overflow-hidden border border-slate-700 flex flex-col card-shadow transition-all hover:translate-y-[-5px] ${h.cantidad <= 3 ? 'stock-critico' : ''} ${isAdmin ? 'admin-mode' : ''}`}>
                    <div className="h-48 bg-black/40 p-4 relative">
                        <img src={h.foto_url} className="w-full h-full object-contain" alt={h.nombre} />
                        {h.cantidad <= 3 && <span className="absolute top-4 right-4 bg-red-600 text-[10px] font-black px-3 py-1 rounded-full shadow-lg">BAJO STOCK</span>}
                    </div>
                    <div className="p-7 flex flex-col flex-grow">
                        <div className="flex justify-between items-start mb-2">
                            <h4 className="text-lg font-black uppercase tracking-tighter leading-tight">{h.nombre}</h4>
                            <span className={`px-3 py-1 rounded-xl font-black text-[10px] ${h.cantidad > 0 ? 'bg-orange-600' : 'bg-red-600 animate-pulse'}`}>STOCK: {h.cantidad}</span>
                        </div>
                        <p className="text-[10px] text-slate-400 font-bold mb-6 italic uppercase">üìç {h.lugar || 'Almac√©n'}</p>
                        
                        {isAdmin ? (
                            <div className="mt-auto space-y-2">
                                <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded-2xl border border-slate-700">
                                    <button onClick={async () => { await supabase.from('herramientas').update({cantidad: Math.max(0, h.cantidad - 1)}).eq('id', h.id); cargarDatos(); }} className="w-10 h-10 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold">-</button>
                                    <span className="font-black text-orange-500 text-xl">{h.cantidad}</span>
                                    <button onClick={async () => { await supabase.from('herramientas').update({cantidad: h.cantidad + 1}).eq('id', h.id); cargarDatos(); }} className="w-10 h-10 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold">+</button>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => prepararEdicion(h)} className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 font-black text-[10px] rounded-xl transition-colors uppercase">Editar</button>
                                    <button onClick={async () => { if(confirm("¬øEliminar?")) { await supabase.from('herramientas').delete().eq('id', h.id); cargarDatos(); } }} className="px-4 py-3 bg-slate-700 text-red-500 font-black text-[10px] rounded-xl uppercase">‚úï</button>
                                </div>
                            </div>
                        ) : (
                            <button onClick={async () => {
                                const n = prompt("Tu nombre:");
                                const t = prompt("Trabajo/Tarea:");
                                const c = prompt("¬øCantidad?");
                                if(n && t && c) {
                                    await supabase.from('pedidos').insert([{ herramienta_id: h.id, herramienta_nombre: h.nombre, usuario_nombre: n, tarea: t, cantidad_pedida: parseInt(c), foto_url: h.foto_url }]);
                                    alert("üöÄ Solicitud enviada");
                                    cargarPedidos();
                                }
                            }} disabled={h.cantidad === 0} className="mt-auto w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all">
                                {h.cantidad > 0 ? 'üöÄ Solicitar Material' : 'Sin Unidades'}
                            </button>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="max-w-6xl mx-auto p-4 lg:p-8">
                    {/* NAV ESTILO PREMIUM */}
                    <nav className="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 glass p-6 rounded-[2.5rem] border border-slate-700 shadow-2xl sticky top-4 z-40">
                        <h1 className="text-2xl font-black text-orange-500 italic uppercase tracking-tighter">Stock Master Elite</h1>
                        <div className="flex flex-wrap justify-center gap-2">
                            {isAdmin && (
                                <>
                                    <button onClick={() => setVista('stock')} className={`px-4 py-2 rounded-xl text-[10px] font-bold ${vista === 'stock' ? 'bg-orange-600' : 'bg-slate-700'}`}>üì¶ STOCK</button>
                                    <button onClick={() => setVista('pedidos')} className={`px-4 py-2 rounded-xl text-[10px] font-bold ${vista === 'pedidos' ? 'bg-blue-600' : 'bg-slate-700'}`}>üì• PEDIDOS ({pedidos.length})</button>
                                    <button onClick={() => setVista('bajo')} className={`px-4 py-2 rounded-xl text-[10px] font-bold ${vista === 'bajo' ? 'bg-red-600' : 'bg-slate-700'}`}>‚ö†Ô∏è STOCK BAJO ({stockCritico.length})</button>
                                </>
                            )}
                            <button onClick={() => isAdmin ? setIsAdmin(false) : setMostrarLogin(true)} className="bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase border border-slate-600 hover:bg-slate-700 transition-all">
                                {isAdmin ? 'Cerrar Sesi√≥n' : 'Admin'}
                            </button>
                        </div>
                    </nav>

                    {mostrarLogin && (
                        <div className="fixed inset-0 bg-black/95 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className="bg-slate-800 p-10 rounded-[3rem] border border-orange-500 w-full max-w-xs text-center shadow-2xl">
                                <h2 className="text-orange-500 font-black mb-6 uppercase tracking-widest">Acceso Privado</h2>
                                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full p-4 bg-slate-900 rounded-2xl mb-6 text-center text-2xl outline-none border border-slate-700 focus:border-orange-500 transition-all" onChange={e => setPassInput(e.target.value)} />
                                <button onClick={() => {if(passInput===ADMIN_PASSWORD) {setIsAdmin(true); setMostrarLogin(false); setVista('stock');}}} className="w-full bg-orange-600 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-orange-500 shadow-lg">Entrar</button>
                            </div>
                        </div>
                    )}

                    {vista === 'stock' && (
                        <>
                            <div className="flex gap-4 mb-10">
                                <input type="text" placeholder="¬øQu√© material buscas hoy?..." className="flex-1 bg-slate-800 p-6 rounded-[2rem] outline-none border border-slate-700 text-lg shadow-inner focus:border-orange-500/50 transition-all" onChange={e => setBusqueda(e.target.value)} />
                                {isAdmin && (
                                    <button onClick={() => { setEditandoId(null); setForm({nombre:'',cantidad:'',lugar:'',foto:null, foto_url:''}); setMostrarForm(!mostrarForm); }} className="bg-green-600 px-10 rounded-[2rem] font-black text-3xl hover:bg-green-500 shadow-lg shadow-green-900/20">
                                        {mostrarForm ? '‚úï' : '+'}
                                    </button>
                                )}
                            </div>

                            {isAdmin && mostrarForm && (
                                <div className="bg-slate-800 p-10 rounded-[3rem] border-2 border-green-600 mb-12 shadow-2xl animate-in fade-in zoom-in duration-300">
                                    <h2 className="text-green-500 font-black mb-8 uppercase tracking-widest text-xl">{editandoId ? 'üõ†Ô∏è Editando Herramienta' : 'üÜï Nuevo Registro de Almac√©n'}</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                                        <input type="text" placeholder="Nombre" className="bg-slate-900 p-5 rounded-2xl border border-slate-700 focus:border-green-500 outline-none" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value})} />
                                        <input type="number" placeholder="Cantidad" className="bg-slate-900 p-5 rounded-2xl border border-slate-700 focus:border-green-500 outline-none" value={form.cantidad} onChange={e => setForm({...form, cantidad: e.target.value})} />
                                        <input type="text" placeholder="Ubicaci√≥n (Ej: Pasillo A)" className="bg-slate-900 p-5 rounded-2xl border border-slate-700 focus:border-green-500 outline-none" value={form.lugar} onChange={e => setForm({...form, lugar: e.target.value})} />
                                    </div>
                                    <input type="file" className="mb-8 block text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-700 file:text-white" onChange={e => setForm({...form, foto: e.target.files[0]})} />
                                    <button onClick={guardarMaterial} disabled={enviando} className="w-full bg-green-600 py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-green-500 shadow-xl disabled:opacity-50">
                                        {enviando ? 'PROCESANDO EN LA NUBE...' : 'GUARDAR CAMBIOS'}
                                    </button>
                                </div>
                            )}

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-20">
                                {herramientas.filter(h => h.nombre.toLowerCase().includes(busqueda.toLowerCase())).map(h => (
                                    <TarjetaHerramienta key={h.id} h={h} />
                                ))}
                            </div>
                        </>
                    )}

                    {vista === 'bajo' && isAdmin && (
                        <div className="animate-in slide-in-from-bottom-4 duration-500">
                            <h2 className="text-3xl font-black text-red-500 mb-10 uppercase italic tracking-tighter flex items-center gap-3">
                                ‚ö†Ô∏è Necesita Reabastecimiento
                            </h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                                {stockCritico.map(h => (
                                    <TarjetaHerramienta key={h.id} h={h} />
                                ))}
                            </div>
                            {stockCritico.length === 0 && <p className="text-center py-40 text-slate-500 font-bold uppercase tracking-widest border-2 border-dashed border-slate-800 rounded-[3rem]">Todo el stock est√° en niveles √≥ptimos ‚úÖ</p>}
                        </div>
                    )}

                    {vista === 'pedidos' && isAdmin && (
                        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                            <h2 className="text-3xl font-black text-blue-400 mb-10 uppercase italic tracking-tighter">Pedidos Recibidos</h2>
                            {pedidos.map(p => (
                                <div key={p.id} className="bg-slate-800 p-8 rounded-[3rem] border border-slate-700 flex flex-col md:flex-row items-center gap-8 shadow-2xl">
                                    <div className="w-32 h-32 bg-black/40 rounded-3xl overflow-hidden p-3 flex-shrink-0 border border-slate-700">
                                        <img src={p.foto_url} className="w-full h-full object-contain" />
                                    </div>
                                    <div className="flex-1 text-center md:text-left uppercase">
                                        <p className="text-orange-500 font-black text-2xl tracking-tighter mb-1">{p.herramienta_nombre} (x{p.cantidad_pedida})</p>
                                        <p className="text-sm font-bold text-slate-300">SOLICITA: <span className="text-white">{p.usuario_nombre}</span></p>
                                        <p className="text-xs italic text-slate-500 mt-2 tracking-widest">TRABAJO: {p.tarea}</p>
                                    </div>
                                    <div className="flex gap-3 w-full md:w-auto">
                                        <button onClick={async () => {
                                            const h = herramientas.find(item => item.id === p.herramienta_id);
                                            if(h && h.cantidad >= p.cantidad_pedida){
                                                await supabase.from('herramientas').update({cantidad: h.cantidad - p.cantidad_pedida}).eq('id', h.id);
                                                await supabase.from('pedidos').delete().eq('id', p.id);
                                                cargarDatos(); cargarPedidos();
                                                alert("‚úì Entregado");
                                            } else { alert("Error: No hay stock suficiente para esta orden"); }
                                        }} className="flex-1 md:flex-none bg-green-600 px-10 py-5 rounded-2xl font-black text-xs uppercase shadow-lg shadow-green-900/40 hover:bg-green-500 transition-all">ENTREGAR</button>
                                        <button onClick={async () => { if(confirm("¬øRechazar pedido?")) { await supabase.from('pedidos').delete().eq('id', p.id); cargarPedidos(); } }} className="bg-slate-700 text-red-500 px-6 py-5 rounded-2xl font-black text-xs uppercase hover:bg-red-600/10 transition-all">X</button>
                                    </div>
                                </div>
                            ))}
                            {pedidos.length === 0 && <p className="text-center py-40 text-slate-500 font-bold uppercase tracking-widest border-2 border-dashed border-slate-800 rounded-[3rem]">Bandeja de pedidos limpia</p>}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
