<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMaster Elite v8 - Ultra Fast</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .card-admin { border: 2px solid #f97316 !important; }
        .card-bajo { border: 2px solid #ef4444 !important; }
        input { transition: border 0.2s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ADMIN_PASSWORD = "123"; 

        const normalizar = (texto) => 
            texto ? texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "";

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [pedidos, setPedidos] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [seccion, setSeccion] = useState('stock'); 
            const [mostrarLogin, setMostrarLogin] = useState(false);
            const [mostrarForm, setMostrarForm] = useState(false);
            const [editandoId, setEditandoId] = useState(null);
            const [enviando, setEnviando] = useState(false);
            
            // Estado del formulario separado para evitar re-renders masivos
            const [form, setForm] = useState({ nombre: '', cantidad: '', lugar: '', foto: null, foto_url: '' });

            useEffect(() => { cargarDatos(); cargarPedidos(); }, []);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('nombre', { ascending: true });
                if (data) setHerramientas(data);
            };

            const cargarPedidos = async () => {
                const { data } = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
                if (data) setPedidos(data);
            };

            const herramientasFiltradas = useMemo(() => {
                const b = normalizar(busqueda);
                return b === "" ? herramientas : herramientas.filter(h => normalizar(h.nombre).includes(b));
            }, [herramientas, busqueda]);

            const stockBajo = useMemo(() => herramientas.filter(h => h.cantidad <= 3), [herramientas]);

            const guardar = async () => {
                if (!form.nombre || form.cantidad === '') return alert("Faltan datos");
                setEnviando(true);
                let urlFinal = form.foto_url || 'https://via.placeholder.com/400x300?text=Sin+Imagen';

                try {
                    if (form.foto && typeof form.foto !== 'string') {
                        const fileName = `${Date.now()}.jpg`;
                        await supabase.storage.from('herramientas').upload(fileName, form.foto);
                        const { data } = supabase.storage.from('herramientas').getPublicUrl(fileName);
                        urlFinal = data.publicUrl;
                    }
                    const material = { nombre: form.nombre, cantidad: parseInt(form.cantidad), lugar: form.lugar, foto_url: urlFinal };
                    if (editandoId) await supabase.from('herramientas').update(material).eq('id', editandoId);
                    else await supabase.from('herramientas').insert([material]);
                    
                    setForm({ nombre: '', cantidad: '', lugar: '', foto: null, foto_url: '' });
                    setEditandoId(null); setMostrarForm(false);
                    cargarDatos();
                } catch (e) { alert(e.message); } finally { setEnviando(false); }
            };

            // Componente de Tarjeta optimizado
            const Tarjeta = useCallback(({ h }) => (
                <div className={`glass rounded-[2rem] overflow-hidden flex flex-col shadow-xl ${h.cantidad <= 3 ? 'card-bajo' : ''} ${isAdmin ? 'card-admin' : ''}`}>
                    <div className="h-40 bg-black/20 p-4">
                        <img src={h.foto_url} className="w-full h-full object-contain" loading="lazy" />
                    </div>
                    <div className="p-5 flex flex-col flex-grow">
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold uppercase text-sm">{h.nombre}</h3>
                            <span className={`text-[10px] px-2 py-1 rounded font-black ${h.cantidad > 0 ? 'bg-orange-600' : 'bg-red-700'}`}>{h.cantidad}</span>
                        </div>
                        <p className="text-[9px] text-slate-400 mb-4 uppercase italic">üìç {h.lugar || 'S/N'}</p>
                        {isAdmin ? (
                            <div className="mt-auto flex gap-2">
                                <button onClick={() => {
                                    setForm({ nombre: h.nombre, cantidad: h.cantidad, lugar: h.lugar, foto_url: h.foto_url });
                                    setEditandoId(h.id); setMostrarForm(true); window.scrollTo(0,0);
                                }} className="flex-1 bg-blue-600 py-2 rounded-lg text-[9px] font-bold uppercase">Editar</button>
                                <button onClick={async () => { if(confirm("¬øBorrar?")) { await supabase.from('herramientas').delete().eq('id', h.id); cargarDatos(); } }} className="bg-slate-700 px-3 rounded-lg text-red-500 font-bold">‚úï</button>
                            </div>
                        ) : (
                            <button onClick={async () => {
                                const n = prompt("Nombre:"); const t = prompt("Tarea:"); const c = prompt("Cantidad:");
                                if(n && t && c) {
                                    await supabase.from('pedidos').insert([{ herramienta_id: h.id, herramienta_nombre: h.nombre, usuario_nombre: n, tarea: t, cantidad_pedida: parseInt(c), foto_url: h.foto_url }]);
                                    alert("Enviado"); cargarPedidos();
                                }
                            }} disabled={h.cantidad <= 0} className="mt-auto w-full bg-blue-600 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest">
                                Solicitar
                            </button>
                        )}
                    </div>
                </div>
            ), [isAdmin]);

            return (
                <div className="max-w-6xl mx-auto p-4 lg:p-10">
                    <nav className="glass p-4 rounded-[2rem] mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-orange-600 rounded-lg flex items-center justify-center font-black">S</div>
                            <h1 className="font-black uppercase tracking-tighter">StockMaster <span className="text-orange-500">Elite</span></h1>
                        </div>
                        <div className="flex gap-2">
                            {isAdmin && (
                                <>
                                    <button onClick={() => setSeccion('stock')} className={`px-4 py-2 rounded-xl text-[9px] font-bold ${seccion === 'stock' ? 'bg-orange-600' : 'bg-slate-800'}`}>STOCK</button>
                                    <button onClick={() => setSeccion('pedidos')} className={`px-4 py-2 rounded-xl text-[9px] font-bold ${seccion === 'pedidos' ? 'bg-blue-600' : 'bg-slate-800'}`}>PEDIDOS</button>
                                    <button onClick={() => setSeccion('bajo')} className={`px-4 py-2 rounded-xl text-[9px] font-bold ${seccion === 'bajo' ? 'bg-red-600' : 'bg-slate-800'}`}>STOCK BAJO</button>
                                </>
                            )}
                            <button onClick={() => isAdmin ? setIsAdmin(false) : setMostrarLogin(true)} className="px-4 py-2 bg-slate-700 rounded-xl text-[9px] font-bold">
                                {isAdmin ? 'SALIR' : 'ADMIN'}
                            </button>
                        </div>
                    </nav>

                    {seccion === 'stock' && (
                        <div>
                            <div className="flex gap-2 mb-8">
                                <input 
                                    type="text" 
                                    placeholder="Buscar..." 
                                    className="flex-1 bg-slate-800/60 p-4 rounded-2xl outline-none border border-transparent focus:border-orange-500"
                                    value={busqueda}
                                    onChange={e => setBusqueda(e.target.value)} 
                                />
                                {isAdmin && (
                                    <button onClick={() => setMostrarForm(!mostrarForm)} className="bg-green-600 px-6 rounded-2xl font-black text-xl">+</button>
                                )}
                            </div>

                            {isAdmin && mostrarForm && (
                                <div className="bg-slate-800 p-6 rounded-[2rem] border border-green-600 mb-8">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <input type="text" placeholder="Nombre" className="bg-slate-900 p-3 rounded-xl border border-slate-700" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value})} />
                                        <input type="number" placeholder="Cantidad" className="bg-slate-900 p-3 rounded-xl border border-slate-700" value={form.cantidad} onChange={e => setForm({...form, cantidad: e.target.value})} />
                                        <input type="text" placeholder="Lugar" className="bg-slate-900 p-3 rounded-xl border border-slate-700" value={form.lugar} onChange={e => setForm({...form, lugar: e.target.value})} />
                                    </div>
                                    <button onClick={guardar} className="w-full bg-green-600 py-3 rounded-xl font-bold uppercase text-xs">Guardar Material</button>
                                </div>
                            )}

                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {herramientasFiltradas.map(h => <Tarjeta key={h.id} h={h} />)}
                            </div>
                        </div>
                    )}

                    {seccion === 'bajo' && isAdmin && (
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {stockBajo.map(h => <Tarjeta key={h.id} h={h} />)}
                        </div>
                    )}

                    {seccion === 'pedidos' && isAdmin && (
                        <div className="space-y-4">
                            {pedidos.map(p => (
                                <div key={p.id} className="glass p-4 rounded-[1.5rem] flex items-center gap-4">
                                    <img src={p.foto_url} className="w-16 h-16 object-contain bg-black/20 rounded-lg" />
                                    <div className="flex-1">
                                        <h4 className="font-bold text-orange-500 text-sm">{p.herramienta_nombre} (x{p.cantidad_pedida})</h4>
                                        <p className="text-[10px] text-slate-400">Por: {p.usuario_nombre}</p>
                                    </div>
                                    <button onClick={async () => {
                                        const mat = herramientas.find(h => h.id === p.herramienta_id);
                                        if(mat && mat.cantidad >= p.cantidad_pedida) {
                                            await supabase.from('herramientas').update({ cantidad: mat.cantidad - p.cantidad_pedida }).eq('id', mat.id);
                                            await supabase.from('pedidos').delete().eq('id', p.id);
                                            cargarDatos(); cargarPedidos();
                                        }
                                    }} className="bg-green-600 p-3 rounded-lg text-[10px] font-bold">OK</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {mostrarLogin && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-8 rounded-[2rem] border border-orange-500 w-full max-w-xs text-center">
                                <input type="password" placeholder="CLAVE" className="w-full p-3 bg-slate-900 rounded-xl mb-4 text-center text-xl" 
                                    onChange={e => e.target.value === ADMIN_PASSWORD && (setIsAdmin(true), setMostrarLogin(false))} />
                                <button onClick={() => setMostrarLogin(false)} className="text-[10px] text-slate-500">CERRAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
