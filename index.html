<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StockMaster Elite v55.0 - ULTRA FAST</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-tech { font-family: 'Orbitron', sans-serif; }
        .glass-card { background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6)); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .btn-primary { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .notif { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 16px; background: #10b981; color: white; font-weight: 900; z-index: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { background: #0a0f1d !important; border: 1px solid rgba(249, 115, 22, 0.2) !important; color: white !important; outline: none; }
        img { transition: opacity 0.4s; opacity: 0; }
        img.loaded { opacity: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ADMIN_PASSWORD = "123";

        // COMPRESOR PARA NUEVAS FOTOS
        const compressImg = (file) => new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 600;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > max) { h *= max / w; w = max; } }
                    else { if (h > max) { w *= max / h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob(res, 'image/webp', 0.6);
                };
            };
        });

        function App() {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('master_v55');
                return saved ? JSON.parse(saved) : { herramientas: [], pedidos: [], historial: [] };
            });
            const [seccion, setSeccion] = useState('stock');
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [modalPedido, setModalPedido] = useState(null);
            const [form, setForm] = useState(null);
            const [notif, setNotif] = useState("");
            const [isWorking, setIsWorking] = useState(false);

            const showMsg = (t) => { setNotif(t); setTimeout(() => setNotif(""), 3000); };

            const sync = useCallback(async () => {
                try {
                    const [h, p, hi] = await Promise.all([
                        supabase.from('herramientas').select('*').order('nombre'),
                        supabase.from('pedidos').select('*').order('created_at', { ascending: false }),
                        supabase.from('historial').select('*').order('fecha', { ascending: false }).limit(50)
                    ]);
                    if (h.data) {
                        const pack = { herramientas: h.data, pedidos: p.data || [], historial: hi.data || [] };
                        setData(pack);
                        localStorage.setItem('master_v55', JSON.stringify(pack));
                    }
                } catch (e) {}
            }, []);

            useEffect(() => {
                sync();
                const ch = supabase.channel('db').on('postgres_changes',{event:'*',schema:'public'},()=>sync()).subscribe();
                return () => supabase.removeChannel(ch);
            }, [sync]);

            // FUNCIÓN DE DESCARGA MASIVA (PLAN DE RESCATE)
            const descargarTodo = async () => {
                if (!confirm("Se descargarán las fotos una por una. Permite las 'Descargas múltiples' en tu navegador si te lo pide.")) return;
                setIsWorking(true);
                showMsg("INICIANDO DESCARGA...");
                for (const h of data.herramientas) {
                    try {
                        const res = await fetch(h.foto_url);
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const nombreLimpio = h.nombre.replace(/[/\\?%*:|"<>]/g, '-');
                        a.download = `${nombreLimpio}.jpg`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        await new Promise(r => setTimeout(r, 250));
                    } catch (e) { console.error("Error bajando:", h.nombre); }
                }
                setIsWorking(false);
                showMsg("PROCESO TERMINADO");
            };

            const filtrados = useMemo(() => {
                const q = busqueda.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                return data.herramientas.filter(h => h.nombre.toLowerCase().includes(q));
            }, [data.herramientas, busqueda]);

            const enviarPedido = async () => {
                if(!modalPedido.user_name || !modalPedido.job) return alert("DATOS INCOMPLETOS");
                const backup = {...data};
                setData(prev => ({
                    ...prev,
                    herramientas: prev.herramientas.map(h => h.id === modalPedido.id ? {...h, cantidad: h.cantidad - modalPedido.pedido_cant} : h)
                }));
                setModalPedido(null);
                showMsg("PROCESANDO...");
                const { error } = await supabase.from('pedidos').insert([{
                    herramienta_id: modalPedido.id, herramienta_nombre: modalPedido.nombre,
                    usuario_nombre: modalPedido.user_name, tarea: modalPedido.job,
                    cantidad_pedida: modalPedido.pedido_cant, foto_url: modalPedido.foto_url
                }]);
                if(error) { setData(backup); alert("FALLÓ LA RED"); }
                sync();
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                setIsWorking(true);
                const blob = await compressImg(file);
                const name = `${Date.now()}.webp`;
                await supabase.storage.from('fotos').upload(name, blob);
                const { data: { publicUrl } } = supabase.storage.from('fotos').getPublicUrl(name);
                setForm({...form, foto_url: publicUrl});
                setIsWorking(false);
            };

            return (
                <div className="min-h-screen pb-24">
                    {isWorking && <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center flex-col gap-4">
                        <div className="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="font-tech text-xs text-orange-500 animate-pulse">TRABAJANDO...</p>
                    </div>}
                    {notif && <div className="notif font-tech text-[10px]">✓ {notif}</div>}

                    <header className="sticky top-0 z-40 p-4 bg-slate-950/90 backdrop-blur-md border-b border-white/5 flex flex-col items-center">
                        <div className="font-tech font-black text-2xl text-white italic mb-4">STOCK<span className="text-orange-500">ELITE</span></div>
                        <nav className="flex gap-2 bg-black/40 p-1.5 rounded-2xl border border-white/5">
                            <button onClick={()=>setSeccion('stock')} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase ${seccion==='stock'?'bg-orange-500 text-white':'text-slate-400'}`}>STOCK</button>
                            {isAdmin && <button onClick={()=>setSeccion('pedidos')} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase ${seccion==='pedidos'?'bg-orange-500 text-white':'text-slate-400'}`}>PEDIDOS</button>}
                            <button onClick={()=>isAdmin?setIsAdmin(false):(prompt("PASS")===ADMIN_PASSWORD && setIsAdmin(true))} className="px-5 py-2 rounded-xl text-[10px] font-black uppercase bg-white/5 text-white">{isAdmin?'SALIR':'ADMIN'}</button>
                        </nav>
                    </header>

                    <main className="p-4">
                        {seccion === 'stock' && (
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                <div className="col-span-full flex gap-2 mb-2">
                                    <input type="text" placeholder="BUSCAR..." className="flex-1 p-4 rounded-2xl font-bold uppercase text-[10px]" value={busqueda} onChange={e=>setBusqueda(e.target.value)} />
                                    <button onClick={descargarTodo} className="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-2xl font-black text-[8px] uppercase leading-tight w-20">Bajar Respaldo</button>
                                </div>
                                {filtrados.map(h => (
                                    <div key={h.id} className="glass-card rounded-[2.5rem] p-4 flex flex-col relative">
                                        <div className="h-32 bg-black/40 rounded-[1.8rem] mb-3 overflow-hidden flex items-center justify-center">
                                            <img src={h.foto_url} className="w-full h-full object-contain p-2" onLoad={(e)=>e.target.classList.add('loaded')} loading="lazy" />
                                        </div>
                                        <h3 className="text-[10px] font-black uppercase text-center h-8 flex items-center justify-center mb-1 leading-tight">{h.nombre}</h3>
                                        <div className="flex justify-between items-center mb-4 px-2 font-tech text-[10px]">
                                            <span className="text-slate-500 text-[8px]">{h.lugar||'S/U'}</span>
                                            <span className="text-orange-500">{h.cantidad} PZ</span>
                                        </div>
                                        <button onClick={()=>isAdmin?setForm(h):setModalPedido({...h, user_name:'', job:'', pedido_cant:1})} disabled={h.cantidad<=0 && !isAdmin} className={`w-full py-4 rounded-2xl font-black text-[10px] uppercase ${h.cantidad<=0 && !isAdmin ? 'bg-slate-800 text-slate-500':'btn-primary text-white shadow-lg'}`}>
                                            {isAdmin ? 'EDITAR' : (h.cantidad<=0 ? 'AGOTADO' : 'PEDIR')}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                        {/* Seccion Pedidos omitida por brevedad pero usa el mismo estilo */}
                    </main>

                    {modalPedido && (
                        <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4">
                            <div className="glass-card p-8 rounded-[3rem] w-full max-w-sm text-center border-orange-500/30 border-2">
                                <img src={modalPedido.foto_url} className="w-24 h-24 mx-auto mb-4 object-contain bg-black/40 rounded-2xl p-2" />
                                <h2 className="font-tech text-orange-500 text-[10px] mb-6 uppercase">{modalPedido.nombre}</h2>
                                <input type="text" placeholder="TU NOMBRE" className="w-full p-4 mb-3 rounded-2xl text-center text-[10px] font-black" value={modalPedido.user_name} onChange={e=>setModalPedido({...modalPedido, user_name:e.target.value.toUpperCase()})} />
                                <input type="text" placeholder="TAREA" className="w-full p-4 mb-6 rounded-2xl text-center text-[10px] font-black" value={modalPedido.job} onChange={e=>setModalPedido({...modalPedido, job:e.target.value.toUpperCase()})} />
                                <div className="flex justify-between items-center bg-black/60 p-2 rounded-2xl mb-8">
                                    <button onClick={()=>setModalPedido({...modalPedido, pedido_cant: Math.max(1, modalPedido.pedido_cant-1)})} className="w-12 h-12 text-orange-500 text-2xl">-</button>
                                    <div className="font-tech text-3xl">{modalPedido.pedido_cant}</div>
                                    <button onClick={()=>setModalPedido({...modalPedido, pedido_cant: Math.min(modalPedido.cantidad, modalPedido.pedido_cant+1)})} className="w-12 h-12 text-orange-500 text-2xl">+</button>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>setModalPedido(null)} className="py-5 bg-white/5 rounded-2xl font-black text-[10px]">CERRAR</button>
                                    <button onClick={enviarPedido} className="py-5 btn-primary rounded-2xl font-black text-[10px] text-white">CONFIRMAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
