<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMaster - Automatizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: white; scroll-behavior: smooth; }
        .admin-border { border: 2px solid #ea580c; }
        .agotado { filter: grayscale(1); opacity: 0.6; }
        .card-shadow { shadow-lg shadow-black/50; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ADMIN_PASSWORD = "123"; 

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [pedidos, setPedidos] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [verPedidos, setVerPedidos] = useState(false);
            const [mostrarLogin, setMostrarLogin] = useState(false);
            const [passInput, setPassInput] = useState('');
            const [cargando, setCargando] = useState(true);

            useEffect(() => { 
                cargarDatos();
                const interval = setInterval(cargarPedidos, 10000); // Auto-actualiza pedidos cada 10 seg
                return () => clearInterval(interval);
            }, []);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('created_at', { ascending: false });
                if (data) setHerramientas(data);
                setCargando(false);
            };

            const cargarPedidos = async () => {
                const { data } = await supabase.from('pedidos').select('*').eq('estado', 'pendiente').order('created_at', { ascending: false });
                if (data) setPedidos(data);
            };

            const handleLogin = () => {
                if (passInput === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setMostrarLogin(false);
                    setPassInput('');
                    cargarPedidos();
                } else { alert("ContraseÃ±a incorrecta"); }
            };

            const enviarSolicitud = async (h) => {
                const uNombre = prompt("Tu nombre:");
                const uTarea = prompt("Â¿Para quÃ© tarea?");
                const uCant = prompt(`Â¿CuÃ¡ntos ${h.nombre} necesitas? (MÃ¡ximo ${h.cantidad})`);
                
                if (uNombre && uTarea && uCant) {
                    if (parseInt(uCant) > h.cantidad) return alert("No hay suficiente stock para ese pedido.");
                    
                    const { error } = await supabase.from('pedidos').insert([
                        { 
                            herramienta_id: h.id, 
                            herramienta_nombre: h.nombre, 
                            usuario_nombre: uNombre, 
                            tarea: uTarea, 
                            cantidad_pedida: parseInt(uCant) 
                        }
                    ]);
                    if (!error) alert("Solicitud enviada. El administrador descontarÃ¡ el stock al entregarte el material.");
                }
            };

            // --- FUNCIÃ“N CLAVE: ENTREGAR Y RESTAR ---
            const procesarEntrega = async (pedido) => {
                // 1. Buscamos la herramienta actual
                const { data: herramienta } = await supabase.from('herramientas').select('cantidad').eq('id', pedido.herramienta_id).single();
                
                if (herramienta) {
                    const nuevaCantidad = herramienta.cantidad - pedido.cantidad_pedida;
                    
                    if (nuevaCantidad < 0) {
                        alert("Error: No puedes entregar mÃ¡s de lo que hay en stock.");
                        return;
                    }

                    // 2. Restamos del inventario
                    await supabase.from('herramientas').update({ cantidad: nuevaCantidad }).eq('id', pedido.herramienta_id);
                    
                    // 3. Marcamos pedido como entregado (o borramos)
                    await supabase.from('pedidos').delete().eq('id', pedido.id);
                    
                    alert("Stock actualizado y pedido procesado.");
                    cargarDatos();
                    cargarPedidos();
                }
            };

            const eliminarPedido = async (id) => {
                await supabase.from('pedidos').delete().eq('id', id);
                cargarPedidos();
            };

            const actualizarStockManual = async (id, nueva) => {
                if (nueva < 0) return;
                await supabase.from('herramientas').update({ cantidad: nueva }).eq('id', id);
                cargarDatos();
            };

            const herramientasFiltradas = useMemo(() => {
                return herramientas.filter(h => h.nombre.toLowerCase().includes(busqueda.toLowerCase()));
            }, [busqueda, herramientas]);

            if (cargando) return <div className="h-screen flex items-center justify-center font-black text-orange-500 text-3xl animate-pulse">SISTEMA DE INVENTARIO...</div>;

            return (
                <div className="max-w-6xl mx-auto p-4 lg:p-10">
                    <nav className="flex justify-between items-center mb-8 bg-slate-800 p-6 rounded-[2rem] border border-slate-700 shadow-2xl">
                        <div>
                            <h1 className="text-2xl font-black text-orange-500 italic tracking-tighter">MASTER STOCK PRO</h1>
                            <p className="text-[10px] font-bold text-slate-400">STATUS: {isAdmin ? "ADMINISTRADOR" : "USUARIO"}</p>
                        </div>
                        <div className="flex gap-3">
                            {isAdmin && (
                                <button onClick={() => setVerPedidos(!verPedidos)} className="relative bg-blue-600 px-5 py-2 rounded-2xl text-xs font-black shadow-lg shadow-blue-900/40">
                                    {verPedidos ? 'ðŸ“¦ VER STOCK' : `ðŸ“¥ SOLICITUDES`}
                                    {pedidos.length > 0 && <span className="absolute -top-2 -right-2 bg-red-500 w-6 h-6 rounded-full flex items-center justify-center text-[10px] animate-bounce">{pedidos.length}</span>}
                                </button>
                            )}
                            <button onClick={isAdmin ? () => setIsAdmin(false) : () => setMostrarLogin(true)} className="bg-slate-700 px-5 py-2 rounded-2xl text-xs font-black">
                                {isAdmin ? 'SALIR' : 'ACCESO ADMIN'}
                            </button>
                        </div>
                    </nav>

                    {mostrarLogin && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-50 p-6">
                            <div className="bg-slate-800 p-10 rounded-[3rem] w-full max-w-sm border-2 border-orange-500">
                                <h2 className="text-2xl font-black mb-6 text-center">LOGIN ADMIN</h2>
                                <input type="password" placeholder="CLAVE" autoFocus className="w-full p-4 bg-slate-900 rounded-2xl mb-6 outline-none border border-slate-700 focus:border-orange-500 text-center text-2xl font-bold" value={passInput} onChange={e => setPassInput(e.target.value)} />
                                <button onClick={handleLogin} className="w-full bg-orange-600 py-4 rounded-2xl font-black text-xl hover:scale-105 transition-transform">ENTRAR</button>
                            </div>
                        </div>
                    )}

                    {verPedidos && isAdmin ? (
                        <div className="animate-in fade-in slide-in-from-bottom-5">
                            <h2 className="text-3xl font-black mb-8 text-blue-400">PEDIDOS POR ENTREGAR</h2>
                            <div className="space-y-4">
                                {pedidos.length > 0 ? pedidos.map(p => (
                                    <div key={p.id} className="bg-slate-800 border border-slate-700 p-6 rounded-[2rem] flex flex-col md:flex-row justify-between items-center gap-6 shadow-xl">
                                        <div className="text-center md:text-left">
                                            <p className="text-orange-500 font-black text-2xl uppercase">{p.herramienta_nombre}</p>
                                            <p className="text-white font-bold text-lg">Cantidad solicitada: <span className="text-blue-400">{p.cantidad_pedida} unidades</span></p>
                                            <p className="text-slate-400 italic">Pedido por: {p.usuario_nombre} | Tarea: {p.tarea}</p>
                                        </div>
                                        <div className="flex gap-3 w-full md:w-auto">
                                            <button onClick={() => procesarEntrega(p)} className="flex-1 bg-green-600 px-8 py-4 rounded-2xl font-black text-xs uppercase hover:bg-green-500 transition-all">âœ“ ENTREGAR Y RESTAR STOCK</button>
                                            <button onClick={() => eliminarPedido(p.id)} className="bg-red-600/20 text-red-500 px-4 rounded-2xl font-bold text-xs uppercase border border-red-500/30">âœ•</button>
                                        </div>
                                    </div>
                                )) : <div className="text-center py-20 text-slate-500 text-2xl italic font-bold">Sin solicitudes pendientes.</div>}
                            </div>
                        </div>
                    ) : (
                        <>
                            <div className="mb-10">
                                <input type="text" placeholder="ðŸ” BUSCAR MATERIAL..." className="w-full bg-slate-800 p-6 rounded-3xl border border-slate-700 outline-none focus:border-orange-500 text-xl font-bold shadow-inner" onChange={e => setBusqueda(e.target.value)} />
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                                {herramientasFiltradas.map(h => (
                                    <div key={h.id} className={`bg-slate-800 rounded-[3rem] overflow-hidden border border-slate-700 flex flex-col hover:border-orange-500 transition-all ${h.cantidad === 0 ? 'agotado' : ''} ${isAdmin ? 'admin-border' : ''} shadow-xl`}>
                                        <div className="h-56 bg-black/40 p-4">
                                            <img src={h.foto_url} className="w-full h-full object-contain" />
                                        </div>
                                        <div className="p-8 flex-grow flex flex-col">
                                            <div className="flex justify-between items-start mb-6">
                                                <h4 className="text-2xl font-black uppercase leading-none tracking-tighter">{h.nombre}</h4>
                                                <div className={`px-4 py-2 rounded-2xl font-black text-sm ${h.cantidad > 0 ? 'bg-orange-600 text-white' : 'bg-red-600 text-white animate-pulse'}`}>
                                                    {h.cantidad > 0 ? `STOCK: ${h.cantidad}` : 'AGOTADO'}
                                                </div>
                                            </div>

                                            {isAdmin ? (
                                                <div className="flex items-center justify-between bg-slate-900 p-3 rounded-2xl mt-auto">
                                                    <button onClick={() => actualizarStockManual(h.id, h.cantidad - 1)} className="w-14 h-14 bg-slate-700 rounded-xl font-black text-3xl hover:bg-red-600">-</button>
                                                    <span className="font-black text-3xl text-orange-500">{h.cantidad}</span>
                                                    <button onClick={() => actualizarStockManual(h.id, h.cantidad + 1)} className="w-14 h-14 bg-slate-700 rounded-xl font-black text-3xl hover:bg-green-600">+</button>
                                                </div>
                                            ) : (
                                                <button onClick={() => enviarSolicitud(h)} disabled={h.cantidad === 0} className="mt-auto w-full bg-blue-600 disabled:bg-slate-800 py-5 rounded-2xl font-black text-sm uppercase tracking-[0.2em] shadow-lg shadow-blue-900/40 active:scale-95 transition-all">
                                                    {h.cantidad > 0 ? 'ðŸš€ SOLICITAR AHORA' : 'MATERIAL AGOTADO'}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
