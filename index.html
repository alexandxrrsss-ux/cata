<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Pro - Inventario Compartido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURACI√ìN DE SUPABASE ---
        // Reemplaza estos valores con los de tu proyecto en Supabase
        const SUPABASE_URL = 'alexandxrrsss-ux's Project';
        const SUPABASE_ANON_KEY = 'sqpeakmzunusclzskngr';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Iconos SVG (Mismos de tu c√≥digo original)
        const Plus = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const Trash2 = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const Edit2 = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const Search = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
        const Package = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;

        function CatalogoHerramientas() {
            const [herramientas, setHerramientas] = useState([]);
            const [mostrarFormulario, setMostrarFormulario] = useState(false);
            const [herramientaEditando, setHerramientaEditando] = useState(null);
            const [busqueda, setBusqueda] = useState('');
            const [cargando, setCargando] = useState(true);
            const [subiendo, setSubiendo] = useState(false);
            const [formulario, setFormulario] = useState({
                nombre: '', cantidad: '', lugar: '', foto: null, fotoUrl: ''
            });

            useEffect(() => {
                cargarHerramientas();
            }, []);

            // OBTENER DATOS DE LA NUBE
            const cargarHerramientas = async () => {
                const { data, error } = await supabase
                    .from('herramientas')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) console.error('Error:', error);
                else setHerramientas(data || []);
                setCargando(false);
            };

            const manejarCambioImagen = (e) => {
                const archivo = e.target.files[0];
                if (archivo) {
                    setFormulario({ ...formulario, foto: archivo, fotoUrl: URL.createObjectURL(archivo) });
                }
            };

            // GUARDAR EN LA NUBE (DATOS E IM√ÅGENES)
            const guardarHerramienta = async () => {
                if (!formulario.nombre || !formulario.cantidad) {
                    alert('Nombre y cantidad son obligatorios');
                    return;
                }

                setSubiendo(true);
                let finalFotoUrl = formulario.fotoUrl;

                // 1. Si hay una foto nueva, subirla al Storage de Supabase
                if (formulario.foto) {
                    const fileExt = formulario.foto.name.split('.').pop();
                    const fileName = `${Math.random()}.${fileExt}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('herramientas') // Debes crear un bucket llamado 'herramientas' en Supabase
                        .upload(fileName, formulario.foto);

                    if (uploadData) {
                        const { data: publicUrl } = supabase.storage
                            .from('herramientas')
                            .getPublicUrl(fileName);
                        finalFotoUrl = publicUrl.publicUrl;
                    }
                }

                const payload = {
                    nombre: formulario.nombre,
                    cantidad: parseInt(formulario.cantidad),
                    lugar: formulario.lugar,
                    foto_url: finalFotoUrl || 'https://via.placeholder.com/300x200?text=Sin+Foto'
                };

                // 2. Insertar o actualizar en la tabla
                if (herramientaEditando) {
                    await supabase.from('herramientas').update(payload).eq('id', herramientaEditando.id);
                } else {
                    await supabase.from('herramientas').insert([payload]);
                }

                setSubiendo(false);
                setMostrarFormulario(false);
                setFormulario({ nombre: '', cantidad: '', lugar: '', foto: null, fotoUrl: '' });
                cargarHerramientas();
            };

            const eliminarHerramienta = async (id) => {
                if (confirm('¬øEliminar para todos los usuarios?')) {
                    await supabase.from('herramientas').delete().eq('id', id);
                    cargarHerramientas();
                }
            };

            const editarHerramienta = (h) => {
                setHerramientaEditando(h);
                setFormulario({
                    nombre: h.nombre,
                    cantidad: h.cantidad.toString(),
                    lugar: h.lugar,
                    foto: null,
                    fotoUrl: h.foto_url
                });
                setMostrarFormulario(true);
            };

            const herramientasFiltradas = herramientas.filter(h =>
                h.nombre.toLowerCase().includes(busqueda.toLowerCase())
            );

            if (cargando) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white text-xl">
                    <Package className="w-12 h-12 text-orange-500 animate-bounce mr-4" />
                    Sincronizando con la nube...
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-900 p-4 text-white">
                    <div className="max-w-6xl mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 className="text-3xl font-bold flex items-center gap-2">
                                <Package className="text-orange-500" /> Inventario Compartido
                            </h1>
                            <div className="flex gap-2 w-full md:w-auto">
                                <div className="relative flex-1">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Search /></span>
                                    <input 
                                        type="text" 
                                        placeholder="Buscar..." 
                                        className="bg-slate-800 rounded-lg pl-10 pr-4 py-2 w-full outline-none focus:ring-2 focus:ring-orange-500"
                                        onChange={(e) => setBusqueda(e.target.value)}
                                    />
                                </div>
                                <button 
                                    onClick={() => { setMostrarFormulario(true); setHerramientaEditando(null); }}
                                    className="bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2"
                                >
                                    <Plus /> Agregar
                                </button>
                            </div>
                        </header>

                        {mostrarFormulario && (
                            <div className="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-xl">
                                <h2 className="text-xl font-bold mb-4">{herramientaEditando ? 'Editar' : 'Nueva Herramienta'}</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input 
                                        type="text" placeholder="Nombre" 
                                        className="bg-slate-900 p-2 rounded border border-slate-700"
                                        value={formulario.nombre}
                                        onChange={e => setFormulario({...formulario, nombre: e.target.value})}
                                    />
                                    <input 
                                        type="number" placeholder="Cantidad" 
                                        className="bg-slate-900 p-2 rounded border border-slate-700"
                                        value={formulario.cantidad}
                                        onChange={e => setFormulario({...formulario, cantidad: e.target.value})}
                                    />
                                    <input 
                                        type="text" placeholder="Ubicaci√≥n" 
                                        className="bg-slate-900 p-2 rounded border border-slate-700"
                                        value={formulario.lugar}
                                        onChange={e => setFormulario({...formulario, lugar: e.target.value})}
                                    />
                                    <div className="md:col-span-3">
                                        <label className="block text-sm mb-1">Subir Foto:</label>
                                        <input type="file" onChange={manejarCambioImagen} className="text-sm" />
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-2">
                                    <button 
                                        disabled={subiendo}
                                        onClick={guardarHerramienta}
                                        className="bg-green-600 px-6 py-2 rounded font-bold hover:bg-green-700 disabled:opacity-50"
                                    >
                                        {subiendo ? 'Guardando...' : 'Confirmar'}
                                    </button>
                                    <button onClick={() => setMostrarFormulario(false)} className="bg-slate-700 px-6 py-2 rounded">Cancelar</button>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            {herramientasFiltradas.map(h => (
                                <div key={h.id} className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-orange-500 transition-all group">
                                    <img src={h.foto_url} className="w-full h-40 object-cover" alt={h.nombre} />
                                    <div className="p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-lg leading-tight">{h.nombre}</h3>
                                            <span className="bg-orange-500 text-xs px-2 py-1 rounded-full font-bold">x{h.cantidad}</span>
                                        </div>
                                        <p className="text-slate-400 text-sm mb-4">üìç {h.lugar || 'No especificada'}</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => editarHerramienta(h)} className="flex-1 bg-slate-700 p-2 rounded hover:bg-blue-600 transition-colors flex justify-center"><Edit2 /></button>
                                            <button onClick={() => eliminarHerramienta(h.id)} className="flex-1 bg-slate-700 p-2 rounded hover:bg-red-600 transition-colors flex justify-center"><Trash2 /></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CatalogoHerramientas />, document.getElementById('root'));
    </script>
</body>
</html>