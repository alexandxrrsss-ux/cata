<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMaster - Sistema de Pedidos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: white; }
        .admin-border { border: 2px solid #ea580c; }
        .agotado { filter: grayscale(1); opacity: 0.6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ADMIN_PASSWORD = "123"; 

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [pedidos, setPedidos] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [verPedidos, setVerPedidos] = useState(false);
            const [mostrarLogin, setMostrarLogin] = useState(false);
            const [passInput, setPassInput] = useState('');
            const [cargando, setCargando] = useState(true);

            useEffect(() => { 
                cargarDatos();
                if(isAdmin) cargarPedidos();
            }, [isAdmin]);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('created_at', { ascending: false });
                if (data) setHerramientas(data);
                setCargando(false);
            };

            const cargarPedidos = async () => {
                const { data } = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
                if (data) setPedidos(data);
            };

            const handleLogin = () => {
                if (passInput === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setMostrarLogin(false);
                    setPassInput('');
                } else { alert("ContraseÃ±a incorrecta"); }
            };

            const enviarSolicitud = async (hNombre) => {
                const uNombre = prompt("Tu nombre:");
                const uTarea = prompt("Â¿Para quÃ© tarea?");
                const uCant = prompt("Â¿Cantidad?");
                
                if (uNombre && uTarea && uCant) {
                    const { error } = await supabase.from('pedidos').insert([
                        { herramienta_nombre: hNombre, usuario_nombre: uNombre, tarea: uTarea, cantidad_pedida: parseInt(uCant) }
                    ]);
                    if (!error) alert("Solicitud enviada al Administrador correctamente.");
                }
            };

            const gestionarPedido = async (id, accion) => {
                if (accion === 'borrar') {
                    await supabase.from('pedidos').delete().eq('id', id);
                } else {
                    await supabase.from('pedidos').update({ estado: 'entregado' }).eq('id', id);
                }
                cargarPedidos();
            };

            const actualizarStock = async (id, nueva) => {
                if (nueva < 0) return;
                const { error } = await supabase.from('herramientas').update({ cantidad: nueva }).eq('id', id);
                if (!error) cargarDatos();
            };

            const herramientasFiltradas = useMemo(() => {
                return herramientas.filter(h => h.nombre.toLowerCase().includes(busqueda.toLowerCase()));
            }, [busqueda, herramientas]);

            if (cargando) return <div className="p-20 text-center font-bold text-orange-500 text-2xl animate-pulse">CARGANDO SISTEMA...</div>;

            return (
                <div className="max-w-6xl mx-auto p-4 lg:p-10">
                    <nav className="flex justify-between items-center mb-8 bg-slate-800 p-6 rounded-[2rem] border border-slate-700 shadow-xl">
                        <div>
                            <h1 className="text-2xl font-black text-orange-500 tracking-tighter italic">STOCK MASTER v2</h1>
                            <p className="text-[10px] font-bold text-slate-400">MODO: {isAdmin ? "ADMINISTRADOR" : "VISITANTE"}</p>
                        </div>
                        <div className="flex gap-2">
                            {isAdmin && (
                                <button onClick={() => setVerPedidos(!verPedidos)} className="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold">
                                    {verPedidos ? 'VER INVENTARIO' : `PEDIDOS (${pedidos.length})`}
                                </button>
                            )}
                            <button onClick={isAdmin ? () => setIsAdmin(false) : () => setMostrarLogin(true)} className="bg-slate-700 px-4 py-2 rounded-xl text-xs font-bold">
                                {isAdmin ? 'SALIR' : 'ADMIN'}
                            </button>
                        </div>
                    </nav>

                    {/* MODAL LOGIN */}
                    {mostrarLogin && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-6">
                            <div className="bg-slate-800 p-8 rounded-[2.5rem] w-full max-w-sm border-2 border-orange-500 shadow-2xl">
                                <h2 className="text-2xl font-black mb-6 text-center">ACCESO PRIVADO</h2>
                                <input type="password" placeholder="ContraseÃ±a" autoFocus className="w-full p-4 bg-slate-900 rounded-2xl mb-6 outline-none border border-slate-700 focus:border-orange-500 text-center text-xl" value={passInput} onChange={e => setPassInput(e.target.value)} />
                                <button onClick={handleLogin} className="w-full bg-orange-600 py-4 rounded-2xl font-black shadow-lg shadow-orange-900/40 hover:bg-orange-500 transition-all">DESBLOQUEAR</button>
                            </div>
                        </div>
                    )}

                    {verPedidos && isAdmin ? (
                        /* SECCIÃ“N DE PEDIDOS PARA EL ADMIN */
                        <div className="animate-in slide-in-from-bottom-4 duration-500">
                            <h2 className="text-3xl font-black mb-6 text-blue-400">BANDEJA DE SOLICITUDES</h2>
                            <div className="grid gap-4">
                                {pedidos.length > 0 ? pedidos.map(p => (
                                    <div key={p.id} className="bg-slate-800 border border-slate-700 p-6 rounded-3xl flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div>
                                            <p className="text-orange-500 font-black text-xl uppercase">{p.herramienta_nombre} (x{p.cantidad_pedida})</p>
                                            <p className="text-white font-bold">Solicita: <span className="text-blue-400">{p.usuario_nombre}</span></p>
                                            <p className="text-slate-400 text-sm italic">Tarea: {p.tarea}</p>
                                        </div>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button onClick={() => gestionarPedido(p.id, 'entregado')} className="flex-1 md:flex-none bg-green-600 px-6 py-3 rounded-xl font-bold text-xs uppercase">âœ“ Entregado</button>
                                            <button onClick={() => gestionarPedido(p.id, 'borrar')} className="flex-1 md:flex-none bg-red-600/20 text-red-500 px-6 py-3 rounded-xl font-bold text-xs uppercase border border-red-500/30">Eliminar</button>
                                        </div>
                                    </div>
                                )) : <p className="text-center py-20 text-slate-500 font-bold italic text-xl">No hay pedidos pendientes...</p>}
                            </div>
                        </div>
                    ) : (
                        /* SECCIÃ“N DE INVENTARIO (USUARIO Y ADMIN) */
                        <>
                            <div className="mb-8 relative">
                                <input type="text" placeholder="ðŸ” Buscar material en stock..." className="w-full bg-slate-800 p-5 pl-14 rounded-2xl border border-slate-700 outline-none focus:border-orange-500 text-lg transition-all" onChange={e => setBusqueda(e.target.value)} />
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                                {herramientasFiltradas.map(h => (
                                    <div key={h.id} className={`bg-slate-800 rounded-[2.5rem] overflow-hidden border border-slate-700 flex flex-col shadow-lg transition-all hover:scale-[1.02] ${h.cantidad === 0 ? 'agotado' : ''} ${isAdmin ? 'admin-border' : ''}`}>
                                        <div className="h-56 bg-black/40 p-4">
                                            <img src={h.foto_url} className="w-full h-full object-contain" />
                                        </div>
                                        <div className="p-6 flex flex-col flex-grow">
                                            <div className="flex justify-between items-start mb-4">
                                                <h4 className="text-xl font-black uppercase tracking-tighter leading-none">{h.nombre}</h4>
                                                <span className={`px-3 py-1 rounded-xl font-black text-xs ${h.cantidad > 0 ? 'bg-orange-600' : 'bg-red-600'}`}>
                                                    {h.cantidad > 0 ? `STOCK: ${h.cantidad}` : 'AGOTADO'}
                                                </span>
                                            </div>

                                            {isAdmin ? (
                                                <div className="flex items-center justify-between bg-slate-900 p-2 rounded-2xl mt-auto">
                                                    <button onClick={() => actualizarStock(h.id, h.cantidad - 1)} className="w-12 h-12 bg-slate-700 rounded-xl font-black text-2xl hover:bg-red-600 transition-colors">-</button>
                                                    <span className="font-black text-2xl text-orange-500">{h.cantidad}</span>
                                                    <button onClick={() => actualizarStock(h.id, h.cantidad + 1)} className="w-12 h-12 bg-slate-700 rounded-xl font-black text-2xl hover:bg-green-600 transition-colors">+</button>
                                                </div>
                                            ) : (
                                                <button onClick={() => enviarSolicitud(h.nombre)} disabled={h.cantidad === 0} className="mt-auto w-full bg-blue-600 disabled:bg-slate-700/50 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
                                                    {h.cantidad > 0 ? 'ðŸš€ Solicitar Material' : 'No disponible'}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
