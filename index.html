<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Maestro - B√∫squeda</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .search-focus:focus { box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3); }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://sqpeakmzunusclzskngr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_O2VwxD3NYmBTLWsxLGd7AQ_Ip8k7FmW'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function App() {
            const [herramientas, setHerramientas] = useState([]);
            const [busqueda, setBusqueda] = useState('');
            const [form, setForm] = useState({ nombre: '', cantidad: '', lugar: '', foto: null });
            const [mostrar, setMostrar] = useState(false);
            const [cargando, setCargando] = useState(true);
            const [enviando, setEnviando] = useState(false);

            useEffect(() => { cargarDatos(); }, []);

            const cargarDatos = async () => {
                const { data } = await supabase.from('herramientas').select('*').order('created_at', { ascending: false });
                if (data) setHerramientas(data);
                setCargando(false);
            };

            // Filtrado en tiempo real
            const herramientasFiltradas = useMemo(() => {
                return herramientas.filter(h => 
                    h.nombre.toLowerCase().includes(busqueda.toLowerCase()) || 
                    (h.lugar && h.lugar.toLowerCase().includes(busqueda.toLowerCase()))
                );
            }, [busqueda, herramientas]);

            const optimizarImagen = (archivo) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(archivo);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 1000;
                            const scale = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
                        };
                    };
                });
            };

            const guardar = async () => {
                if (!form.nombre || !form.cantidad) return alert("Nombre y cantidad obligatorios");
                setEnviando(true);
                let urlFinal = 'https://via.placeholder.com/300x200?text=Sin+Foto';

                if (form.foto) {
                    const fotoChica = await optimizarImagen(form.foto);
                    const nombreArchivo = `${Date.now()}.jpg`;
                    const { data: uploadData } = await supabase.storage.from('herramientas').upload(nombreArchivo, fotoChica);
                    if (uploadData) {
                        const { data } = supabase.storage.from('herramientas').getPublicUrl(nombreArchivo);
                        urlFinal = data.publicUrl;
                    }
                }

                await supabase.from('herramientas').insert([{ 
                    nombre: form.nombre, 
                    cantidad: parseInt(form.cantidad), 
                    lugar: form.lugar, 
                    foto_url: urlFinal 
                }]);

                setForm({ nombre: '', cantidad: '', lugar: '', foto: null });
                setMostrar(false);
                setEnviando(false);
                cargarDatos();
            };

            const eliminar = async (id) => {
                if (confirm("¬øEliminar herramienta?")) {
                    await supabase.from('herramientas').delete().eq('id', id);
                    cargarDatos();
                }
            };

            if (cargando) return <div className="p-10 text-center text-xl text-orange-500 font-bold">Actualizando base de datos...</div>;

            return (
                <div className="max-w-6xl mx-auto p-4 lg:p-8">
                    {/* ENCABEZADO */}
                    <header className="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                        <div>
                            <h1 className="text-4xl font-black text-white tracking-tighter italic">INVENTARIO <span className="text-orange-500 underline">CLOUD</span></h1>
                            <p className="text-slate-500 font-medium">Control total de materiales</p>
                        </div>
                        <button onClick={() => setMostrar(!mostrar)} className="w-full md:w-auto bg-orange-600 hover:bg-orange-500 px-8 py-3 rounded-2xl font-black text-lg transition-all shadow-xl shadow-orange-900/40">
                            {mostrar ? '‚úï CERRAR PANEL' : '+ AGREGAR NUEVO'}
                        </button>
                    </header>

                    {/* BARRA DE B√öSQUEDA */}
                    <div className="relative mb-10">
                        <input 
                            type="text" 
                            placeholder="üîç Buscar herramienta por nombre o ubicaci√≥n..." 
                            className="w-full bg-slate-800 p-5 pl-12 rounded-2xl border border-slate-700 outline-none text-xl search-focus transition-all"
                            value={busqueda}
                            onChange={(e) => setBusqueda(e.target.value)}
                        />
                        {busqueda && (
                            <button 
                                onClick={() => setBusqueda('')} 
                                className="absolute right-5 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white font-bold"
                            >
                                LIMPIAR
                            </button>
                        )}
                    </div>

                    {/* FORMULARIO */}
                    {mostrar && (
                        <div className="bg-slate-800 p-8 rounded-3xl mb-12 border-2 border-orange-500/30 shadow-2xl">
                            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">üìù Nuevo Registro</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <input type="text" placeholder="Nombre de herramienta" className="bg-slate-900 p-4 rounded-xl border border-slate-700 outline-none focus:border-orange-500" onChange={e => setForm({...form, nombre: e.target.value})} />
                                <input type="number" placeholder="Cantidad" className="bg-slate-900 p-4 rounded-xl border border-slate-700 outline-none focus:border-orange-500" onChange={e => setForm({...form, cantidad: e.target.value})} />
                                <input type="text" placeholder="Ubicaci√≥n" className="bg-slate-900 p-4 rounded-xl border border-slate-700 outline-none focus:border-orange-500" onChange={e => setForm({...form, lugar: e.target.value})} />
                                <div className="flex flex-col gap-1">
                                    <label className="text-[10px] font-bold text-orange-500 uppercase ml-2">Foto de material</label>
                                    <input type="file" accept="image/*" className="text-sm text-slate-400 file:bg-slate-700 file:text-white file:border-0 file:rounded-lg file:px-3 file:py-1 cursor-pointer" onChange={e => setForm({...form, foto: e.target.files[0]})} />
                                </div>
                            </div>
                            <button onClick={guardar} disabled={enviando} className="mt-8 w-full bg-green-600 hover:bg-green-500 p-4 rounded-2xl font-black text-xl transition-all disabled:opacity-50">
                                {enviando ? 'PROCESANDO...' : 'GUARDAR AHORA'}
                            </button>
                        </div>
                    )}

                    {/* GRILLA DE RESULTADOS */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        {herramientasFiltradas.length > 0 ? (
                            herramientasFiltradas.map(h => (
                                <div key={h.id} className="bg-slate-800 rounded-[2rem] overflow-hidden border border-slate-700 flex flex-col hover:scale-[1.02] transition-transform duration-300">
                                    <div className="h-64 bg-black/60 flex items-center justify-center p-3">
                                        <img src={h.foto_url} className="w-full h-full object-contain" alt={h.nombre} />
                                    </div>
                                    <div className="p-6 flex flex-col flex-grow">
                                        <div className="flex justify-between items-start gap-2 mb-4">
                                            <h2 className="text-xl font-black uppercase text-white tracking-tight leading-none">{h.nombre}</h2>
                                            <span className="bg-orange-600 text-white px-3 py-1 rounded-xl font-black text-sm">x{h.cantidad}</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-slate-400 mb-6 font-medium">
                                            <span className="text-orange-500">üìç</span>
                                            <span className="truncate">{h.lugar || 'N/A'}</span>
                                        </div>
                                        <button 
                                            onClick={() => eliminar(h.id)} 
                                            className="mt-auto w-full py-3 text-red-500 text-[10px] font-black uppercase tracking-[0.2em] border border-red-500/20 rounded-xl hover:bg-red-500 hover:text-white transition-all"
                                        >
                                            Borrar del sistema
                                        </button>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="col-span-full py-20 text-center">
                                <p className="text-3xl font-bold text-slate-700 italic">"No se encontr√≥ ninguna herramienta"</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
